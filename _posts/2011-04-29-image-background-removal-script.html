---
layout: post
title: Image Background Removal Script
date: '2011-04-29T20:10:00.002+08:00'
author: Marco Enrico
tags:
- imagemagick
- python
modified_time: '2015-08-27T03:40:24.387+08:00'
blogger_id: tag:blogger.com,1999:blog-4089002134272543494.post-2922609260779922153
blogger_orig_url: http://mvalviar.blogspot.com/2011/04/image-background-removal-script.html
---

Nothing to do but code:<br /><br /><pre class="brush:python">#!/usr/bin/env python<br />#<br /># rmbg.py - Image Background Removal Script<br />#<br /># Copyright 2010 Marco Enrico Alviar mvalviar_at_gmail.com<br /># This program is free software: you can redistribute it and/or modify<br /># it under the terms of the GNU General Public License as published by<br /># the Free Software Foundation, either version 3 of the License, or<br /># (at your option) any later version.<br /># <br /># This program is distributed in the hope that it will be useful,<br /># but WITHOUT ANY WARRANTY; without even the implied warranty of<br /># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the<br /># GNU General Public License for more details.<br />#<br /># You should have received a copy of the GNU General Public License<br /># along with this program.  If not, see <http: licenses="" www.gnu.org="">.<br /><br />"""Attempt to remove the given background image, given color, or top-left<br />corner pixel color (optionally offset by x,y), from the input image,<br />anti-aliasing the pixels between the percentage values 'fuzz_out' and<br />'fuzz_in'.<br /><br />The 'fuzz_out' percentage defines the pixels that will be definateally<br />classed as background (outside the object in the 'image'.  The lower the<br />value the better, but too low and the main image may become surrounded by<br />too many semi-transparent pixels.<br /><br />The 'fuzz_in' percentage defines what pixels should be definatally inside<br />the object in the image.  Pixels that differ by this much from the<br />background will be classed as fully-opaque.  If too low you may get halo<br />effects, while is too big the semi-transparent edging pixels make 'leak'<br />into the main object.<br /><br />The program assumes the object in the image has some definate 'threshold'<br />division between inside and outside.  It will by default color re-color<br />semi-transparent areas black (shadow), but the -b option lets you change<br />that.<br /><br />Based on <http: bg_removal="" imagemagick.org="" scripts="" usage=""><br /><br />Marco Enrico Alviar          29 April 2011           mvalviar_at_gmail.com<br /><br />"""<br /><br /><br />import sys<br />import os<br />import argparse<br />import __main__<br /><br />def main():<br />background = 'black'<br /><br />description = '\n'.join(__main__.__doc__.split('\n')[:-3])<br />epilog = '\n'.join(__main__.__doc__.split('\n')[-4:-1])<br />parser = argparse.ArgumentParser(description=description, epilog=epilog, formatter_class=argparse.RawDescriptionHelpFormatter)<br />parser.add_argument('image_in', type=str, help='base image')<br />parser.add_argument('background|color', nargs='?', type=str, help='background image file name or color (defaults to the color of pixel(x,y) of base image, see below)')<br />parser.add_argument('fuzz_out', type=int, help='fuzz value of background pixels')<br />parser.add_argument('fuzz_in', type=int, help='fuzz value of foreground pixels')<br />parser.add_argument('image_out', help='output image file name')<br />parser.add_argument('-a', action='store_true', help='add the channel differences instead of simply grayscaling')<br />parser.add_argument('-m', action='store_true', help='flicker compare (space to swap) the masks found with the original image. Press "q" to continue processing, green=object, blue=semi-transparent edge, red=transparency')<br />parser.add_argument('-n', action='store_true', help='Normalize the differences between image and background')<br />parser.add_argument('-r', action='store_true', help='use color replacement instead of flood-fill for mask generation (this lets you find "holes" within the image object')<br />parser.add_argument('-b', metavar='background', type=str, help='use this color for background (shadow) semi-transparent (def: black)')<br />parser.add_argument('-d', action='store_true', help='display image_out after processing')<br />parser.add_argument('-x', nargs=1, help='x-position of pixel (def: 0, ignored if background|color is set)')<br />parser.add_argument('-y', nargs=1, help='y-position of pixel (def: 0,ignored if background|color is set)')<br /><br />args = vars(parser.parse_args(sys.argv[1:]))<br /><br />if args['r']:<br />fill = '-opaque black'<br />else:<br />fill = '-bordercolor black -border 1x1 -floodfill +0+0 black -shave 1x1'<br /><br />if args['m']:<br />showmasks = '( -clone 3,2,4 -combine -clone 0 -write x: -delete 0--1 )'<br />else:<br />showmasks = ''<br /><br />if args['a']:<br />grayscale='-separate -compose plus -background black -flatten'<br />else:<br />grayscale= '-colorspace gray'<br /><br />if args['n']:<br />grayscale = grayscale + ' -normalize'<br /><br />if args['background|color']:<br />for c in args['background|color']:<br />if '-:/. '.find(c) &gt; -1: # not a color<br />bgnd = '"' + args['background|color'] + '"'<br />break<br />else:<br />bgnd = '( +clone -sparse-color voronoi 0,0,' + "'" + args['background|color'] + "'" + ' )'<br />else:<br />bgnd='( +clone -sparse-color voronoi 0,0,%%[pixel:p\{{ "{%" }}d,%d\}] )' % (<br />int(args['x'][0]) if args['x'] else 0,<br />int(args['y'][0]) if args['y'] else 0)<br /><br />image, fzin, fzout, image_out = args['image_in'], args['fuzz_in'], args['fuzz_out'], args['image_out']<br /><br />cmd = """convert "{image}" <br />( -clone 0 {bgnd} -compose Difference -composite <br />{grayscale} <br />-channel B -evaluate 'set' 0 +channel ) <br />( -clone 1 -fill blue -fuzz {fzout}%  {fill}<br />-channel B -separate +channel ) <br />( -clone 1 -fill blue -fuzz {fzin}%  {fill} <br />-channel B -separate +channel -negate ) <br />( -clone 2,3 -negate -compose multiply -composite ) <br />{showmasks} <br />( -clone 0,3 +matte -compose CopyOpacity -composite ) <br />( -clone 1 -channel R -separate +channel <br />-clone 4 +matte -compose CopyOpacity -composite <br />( +clone -blur 0x30 +matte ) +swap -compose Over -composite <br />+matte -normalize <br />-clone 4 -compose multiply -composite  <br />-background {background} -alpha shape <br />-clone 5 -compose over -composite ) <br />-delete 0--2 "{image_out}" """<br /><br />if args['d']:<br />cmd += ' &amp;&amp; display {image_out}'<br /><br />cmd = cmd.format(**locals())<br />cmd = cmd.replace('\n', ' ') .replace('(', '\(').replace(')', '\)')<br />while cmd != cmd.replace('  ', ' '): cmd = cmd.replace('  ', ' ')<br />os.system(cmd)<br /><br /><br />if __name__ == '__main__':<br />    main()<br /></mvalviar_at_gmail.com></http:></http:></mvalviar_at_gmail.com></pre>