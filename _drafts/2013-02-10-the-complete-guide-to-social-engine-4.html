---
layout: post
title: 'The Complete Guide to Social Engine 4 Module Development Part 6: Widgets and
  Pages'
date: '2013-02-10T18:05:00.000-08:00'
author: Marco Enrico
tags:
- widgets
- pages
- development
- se4
- social engine
modified_time: '2013-07-23T02:47:17.592-07:00'
blogger_id: tag:blogger.com,1999:blog-8533127149230967660.post-6253732746659857366
blogger_orig_url: http://social-engine-tutorials.blogspot.com/2013/02/the-complete-guide-to-social-engine-4.html
---

<h2>Widgets </h2>Widget creation is one of the most common tasks in SE4 module development. Widgets are called "blocks" in the admin panel which in my opinion is a better term and for the rest of this post I will use blocks and widgets interchangeably. Widgets can contain forms, lists, menus and other widgets.<br /><br />Widget codes are contained in a modules "widgets" path so a modules widgets path relative to the SE4 install directory is: application/modules/&lt;Modulename&gt;/widgets. Widget names are prefixed with the modules name (following the rules discussed in earlier posts) and a period (ex. core.html-block and core.comment). Widgets can also reside outside of a module which is the case if you decide to use SE4 SDK to create a widget package. These widgets reside in application/widgets and their names are not prefixed with a module name.<br /><br />To create a widget we need to create a sub-directory in the widgets path. In our case we want to create a widget called "profile-cars". This widget is meant to be used in the users' profile page in the main page tabs similar to profile-videos and profile-albums in the Video module and Album module respectively. The name of the widget is "car.profile-cars" and the path is application/modules/Car/widgets/profile-cars. Within this directory we create Controller.php and index.php. We define a Controller class in Controller.php following this pattern:<br /><br /><br /><script class="brush:php" type="syntaxhighlighter"><![CDATA[ class &lt;Modulename&gt;_Widget_&lt;WidgetName&gt;Controller extends Engine_Content_Widget_Abstract  {   public function indexAction()   {   } } ]]></script> With these in place we now have a complete widget. One way to test it is with the content view helper. You can use the following code to display a widget on any view script:<br /><br /><script class="brush:php" type="syntaxhighlighter"><![CDATA[ &lt;?php echo $this-&gt;content()-&gt;renderWidget('modulename.widget-name') ?>]]></script> As it is our widget will render but we wont see anything in the browser since our index.tpl file is empty. We'll get into that soon. First let us make sure that our widget is available for use in pages in the admin panel. To do that we need to add our widgets specs in our modules content.php file. This file is located in application/modules/Modulename/settings/content.php. This file contains the specifications of the widgets provided by the module.<br /><br />Here is the list of the possible spec parameters, their possible values and what they mean:<br /><br /><ul><li><b>type</b> - optional and defaults to "widget". </li><li><b>title</b> - The title of the widget. This appears on the admin end as the label of the block in the available blocks list.</li><li><b>description</b> - The description of the widget. This appears on the admin end as the tool tip when hovering on the block.</li><li><b>name</b> - The name of&nbsp; the widget. This is the full name of the widget as discussed earlier. This is the name used in the name parameter when using the renderWidget&nbsp; of the content view helper. This is also name field of the engine4_core_content table then the changes in the page is saved.</li><li><b>category</b> - The available blocks list is categorized. The category is independent of the name of the module that contains the widget. You may create your own category or put your widget on an existing category. Note that the category name is case sensitive and that not setting this parameter will cause the widget to be unavailable in the layout editor.</li><li><b>special</b> - A non-empty value means the block is the first block on the category it is in. This also makes the background orange instead of green.</li><li><b>autoEdit</b> - A non-empty value means the edit form pop-up displays when the block is dropped on the page. The edit form pop-up for non-autoedit blocks only displays then the edit link is clicked on the block.</li><li><b>adminForm</b> - defines the structure of the block's edit form in the layout editor. The elements of this form defines the block's parameters. These parameters are stored as JSON in the engine4_core_content table's params field. On the widgets controller all parameters can be retrieved with _getAllParams and individual parameters can be retrieved with _getParam. adminForm follows the following structure: <br /><br /><script class="brush:php" type="syntaxhighlighter"><![CDATA[ 'adminForm' =&gt;   'elements' =&gt; array(      array(        'elementtype', // text, textarea, radio, checkbox, etc        'name',        // the name of the parameters/field        array(          // Options. These are passed in the element class' constructor as the options parameter          'label' =&gt; ...          'required' =&gt; ...          'validators' =&gt; ... ]]></script><br />&nbsp;Not setting this parameter means the edit form will only have the title field for editing. Errors will occur if this parameter is set incorrectly. When this parameter is set SE4 will automatically prepend the title field (if not manually defined) and append the "hide on mobile site" field.</li><li><b id="requirements">requirements</b> - The page requirements of the widget that determines whether or not the widget will render.&nbsp; Pages (discussed <a href="http://www.blogger.com/blogger.g?blogID=8533127149230967660#provides">below</a>) have a provides field. This can be one of the following: no-subject, subject, subject=&lt;item name&gt;, viewer, no-viewer. A block that requires no-viewer will only render if the page is being viewed while the user is not logged in. A block that requires subject=car will only render if the page's subject is a car. There are special cases of requires. These are header-footer and page-content. Widgets that require header-footer will only render when placed on the header/footer page fragments. Page-content is only used in the widget core.content which contains the rendered content of a view script if a controller invokes: <br /><br /><script class="brush:php" type="syntaxhighlighter"><![CDATA[ $this->_helper->content->setEnabled() ]]></script></li><li>&nbsp;<b>isPaginated</b> - a non-empty field means the page will be paginated and the parameter form will include the count field which determines the number of pages to show per page. Additional code must be written for paginated widgets discussed below.</li><li><b>defaultParams</b> - The default value of the parameters. </li><li><b>canHaveChildren/childAreaDescription</b> - only used in core.container-tabs.</li></ul>Here is the specification of our car.profile-cars widget:<br /><br /><script class="brush:php" type="syntaxhighlighter"><![CDATA[   array(     'title' =&gt; 'Profile Cars',     'description' =&gt; 'Displays a member\'s cars on their profile.',     'category' =&gt; 'Cars',     'type' =&gt; 'widget',     'name' =&gt; 'car.profile-cars',     'isPaginated' =&gt; true,     'requirements' =&gt; array(       'subject' =&gt; 'user',     ),   ), ]]></script> Here is the controller code:<br /><br /><script class="brush:php" type="syntaxhighlighter"><![CDATA[ <?php  class Car_Widget_ProfileCarsController extends Engine_Content_Widget_Abstract {   // required since our widget "isPaginated"   protected $_childCount;    public function indexAction()   {     // Don't render this if not authorized     $viewer = Engine_Api::_()->user()->getViewer();     if( !Engine_Api::_()->core()->hasSubject() ) {       return $this->setNoRender();     }      // Get subject and check auth     $subject = Engine_Api::_()->core()->getSubject();     if( !$subject->authorization()->isAllowed($viewer, 'view') ) {       return $this->setNoRender();     }      // Get paginator     $profile_owner_id = $subject->getIdentity();     $this->view->paginator = $paginator = Engine_Api::_()->car()->getCarsPaginator(array(       'user_id' => $profile_owner_id,       'search' => 1     ));      // Set item count per page and current page number     // note that $this->_getParam accepts an optional parameter which will serve as</pre>// the value of the parameter should the parameter be empty. $paginator->setItemCountPerPage($this->_getParam('itemCountPerPage', 8));     $paginator->setCurrentPageNumber($this->_getParam('page', 1));      // Do not render if nothing to show     if( $paginator->getTotalItemCount() <= 0 ) {       return $this->setNoRender();     } else {       $this->_childCount = $paginator->getTotalItemCount();     }   }   // required since our widget "isPaginated"   public function getChildCount()   {     return $this->_childCount;   } } ]]></script> Widgets have decorators and in the widget's controller we can manipulate these decorators. We can also retrieve the widgets' parameters and tell the widget to render or not render.<br /><br />Any uncaught exceptions raised in the widget's controller or view script&nbsp; will cause it not to render and messages will be written in the error log. In addition, if the site is in development mode messages will be shown via fire php. You may use $this-&gt;setNoRender(true) to cause the element not to render. You usually want&nbsp; the rest of the controller code to be skipped if you don't want the widget to render so return $this-&gt;setNoRender(true) would be better.<br /><br />By default widgets have two decorators: title and container. The generally have the following html structure:<br /><br /><script class="brush:php" type="syntaxhighlighter"><![CDATA[ <div class="generic_layout_container layout_<modulename>_<widget_name>"> <h3><title></h3><!-- widget body --></div>]]></script> We may use the outer most div's class to be able to style the widget via css. The outer most div of the widget is the container decorator of the widget. This can be manipulated via $this-&gt;getElement()-&gt;getDecorator('container') in the widget's controller. The title decorator on displays if the title parameter is set in the layout editor or a default value is set in the widget specification. In the widgets controller these can be overwritten my manipulating the title decorator. $this-&gt;getElement()-&gt;getDecorator('title')-&gt;setTitle('My Widget') will set the widgets title to "My Widget" ignoring the values set in the layout editor or the widget specification.<br /><br /><h2>Pages</h2>Some of the views in social engine modules have views that can be edited via the layout editor in the admin panel. Examples are video browse page, album browse page and user/member profile page. In our car module we want the browse and view pages to be editable in the layout editor in the admin panel. Pages are instances of Core_Model_Page and&nbsp; are stored in engine4_core_pages and the description this table's fields follows:<br /><ul><li><b>page_id</b> - the table's primary key. This is the page query parameter of the layout editor.</li><li><b>name</b> - the name of the action that will render this page of the format &lt;module-name&gt;_&lt;controller-name&gt;_&lt;action-name&gt;.&nbsp;</li><li><b>displayname</b> - the name of the page as it appears in the layout editor.</li><li><b>url</b> - only applicable to custom pages.</li><li><b>title</b> - the title of the page. On the title tag this appears as &lt;site title&gt; - &lt;page title&gt;. The title tag can be manipulated via the headTitle view helper.</li><li><b>description/keywords</b> - appears on the meta description and the meta-tag of the page</li><li><b>custom</b> - a flag indicating if the page is created via the layout editor.</li><li><b>layout</b> - the layout that the page will use. Value must be one of the base names of the layout scripts in application/modules/Core/layout/scripts. Leaving this empty will use the aptly named layout script default.tpl.</li><li><b>levels</b> - only applicable to custom pages. Determines the user levels that can view this page.</li><li id="provides"><b>provides</b> - what the page provides. Determines whether or not the widgets on this page will render or not. See <a href="http://www.blogger.com/blogger.g?blogID=8533127149230967660#requirements">above</a>.</li><li><b>view_count</b> - the number of times the page has been viewed. </li></ul>For non-custom pages the page structure are created when the module is installed via the callback class. In our car modules manifest.php we have: <br /><br /><script class="brush:php" type="syntaxhighlighter"><![CDATA[     'callback' =&gt; array(       'path' =&gt; 'application/modules/Car/settings/install.php',       'class' =&gt; 'Car_Installer',     ),  ]]></script> (for a details about the manifest file see this <a href="{{ site.baseurl }}{% post_url 2012-05-09-social-engine-package-manifest-file %}" target="_blank">page</a>)<br /><br />We define the Car_Installer class in application/modules/Car/settings/install.php:<br /><br /><script class="brush:php" type="syntaxhighlighter"><![CDATA[ class Car_Installer extends Engine_Package_Installer_Module {   public function onInstall()   {     $this-&gt;_addUserProfileContent();     $this-&gt;_addCarViewPage();     $this-&gt;_addCarBrowsePage();          parent::onInstall();   }    protected function _addCarBrowsePage()   {     $db = $this-&gt;getDb();      // profile page     $page_id = $db-&gt;select()       -&gt;from('engine4_core_pages', 'page_id')       -&gt;where('name = ?', 'car_index_browse')       -&gt;limit(1)       -&gt;query()       -&gt;fetchColumn();          // insert if it doesn't exist yet     if( !$page_id ) {       // Insert page       $db-&gt;insert('engine4_core_pages', array(         'name' =&gt; 'car_index_browse',         'displayname' =&gt; 'Car Browse Page',         'title' =&gt; 'Car Browse',         'description' =&gt; 'This page lists cars.',         'custom' =&gt; 0,       ));       $page_id = $db-&gt;lastInsertId();              // Insert top       $db-&gt;insert('engine4_core_content', array(         'type' =&gt; 'container',         'name' =&gt; 'top',         'page_id' =&gt; $page_id,         'order' =&gt; 1,       ));       $top_id = $db-&gt;lastInsertId();              // Insert main       $db-&gt;insert('engine4_core_content', array(         'type' =&gt; 'container',         'name' =&gt; 'main',         'page_id' =&gt; $page_id,         'order' =&gt; 2,       ));       $main_id = $db-&gt;lastInsertId();              // Insert top-middle       $db-&gt;insert('engine4_core_content', array(         'type' =&gt; 'container',         'name' =&gt; 'middle',         'page_id' =&gt; $page_id,         'parent_content_id' =&gt; $top_id,       ));       $top_middle_id = $db-&gt;lastInsertId();              // Insert main-middle       $db-&gt;insert('engine4_core_content', array(         'type' =&gt; 'container',         'name' =&gt; 'middle',         'page_id' =&gt; $page_id,         'parent_content_id' =&gt; $main_id,         'order' =&gt; 2,       ));       $main_middle_id = $db-&gt;lastInsertId();              // Insert main-right       $db-&gt;insert('engine4_core_content', array(         'type' =&gt; 'container',         'name' =&gt; 'right',         'page_id' =&gt; $page_id,         'parent_content_id' =&gt; $main_id,         'order' =&gt; 1,       ));       $main_right_id = $db-&gt;lastInsertId();              // Insert menu       $db-&gt;insert('engine4_core_content', array(         'type' =&gt; 'widget',         'name' =&gt; 'car.browse-menu',         'page_id' =&gt; $page_id,         'parent_content_id' =&gt; $top_middle_id,         'order' =&gt; 1,       ));              // Insert content       $db-&gt;insert('engine4_core_content', array(         'type' =&gt; 'widget',         'name' =&gt; 'core.content',         'page_id' =&gt; $page_id,         'parent_content_id' =&gt; $main_middle_id,         'order' =&gt; 1,       ));              // Insert search       $db-&gt;insert('engine4_core_content', array(         'type' =&gt; 'widget',         'name' =&gt; 'car.browse-search',         'page_id' =&gt; $page_id,         'parent_content_id' =&gt; $main_right_id,         'order' =&gt; 1,       ));              // Insert gutter menu       $db-&gt;insert('engine4_core_content', array(         'type' =&gt; 'widget',         'name' =&gt; 'car.browse-menu-quick',         'page_id' =&gt; $page_id,         'parent_content_id' =&gt; $main_right_id,         'order' =&gt; 2,       ));     }   }       protected function _addUserProfileContent()   {     $db     = $this-&gt;getDb();     $select = new Zend_Db_Select($db);           // profile page     $select       -&gt;from('engine4_core_pages')       -&gt;where('name = ?', 'user_profile_index')       -&gt;limit(1);     $page_id = $select-&gt;query()-&gt;fetchObject()-&gt;page_id;       // car.profile-cars      // Check if it's already been placed     $select = new Zend_Db_Select($db);     $select       -&gt;from('engine4_core_content')       -&gt;where('page_id = ?', $page_id)       -&gt;where('type = ?', 'widget')       -&gt;where('name = ?', 'car.profile-cars')       ;     $info = $select-&gt;query()-&gt;fetch();      if( empty($info) ) {        // container_id (will always be there)       $select = new Zend_Db_Select($db);       $select         -&gt;from('engine4_core_content')         -&gt;where('page_id = ?', $page_id)         -&gt;where('type = ?', 'container')         -&gt;limit(1);       $container_id = $select-&gt;query()-&gt;fetchObject()-&gt;content_id;        // middle_id (will always be there)       $select = new Zend_Db_Select($db);       $select         -&gt;from('engine4_core_content')         -&gt;where('parent_content_id = ?', $container_id)         -&gt;where('type = ?', 'container')         -&gt;where('name = ?', 'middle')         -&gt;limit(1);       $middle_id = $select-&gt;query()-&gt;fetchObject()-&gt;content_id;        // tab_id (tab container) may not always be there       $select         -&gt;reset('where')         -&gt;where('type = ?', 'widget')         -&gt;where('name = ?', 'core.container-tabs')         -&gt;where('page_id = ?', $page_id)         -&gt;limit(1);       $tab_id = $select-&gt;query()-&gt;fetchObject();       if( $tab_id &amp;&amp; @$tab_id-&gt;content_id ) {           $tab_id = $tab_id-&gt;content_id;       } else {         $tab_id = null;       }        // tab on profile       $db-&gt;insert('engine4_core_content', array(         'page_id' =&gt; $page_id,         'type'    =&gt; 'widget',         'name'    =&gt; 'car.profile-cars',         'parent_content_id' =&gt; ($tab_id ? $tab_id : $middle_id),         'order'   =&gt; 12,         'params'  =&gt; '{"title":"Cars","titleCount":true}',       ));      }   }    protected function _addCarViewPage()   {     $db     = $this-&gt;getDb();     $select = new Zend_Db_Select($db);          // Check if it's already been placed     $select = new Zend_Db_Select($db);     $select       -&gt;from('engine4_core_pages')       -&gt;where('name = ?', 'car_index_view')       -&gt;limit(1);       ;     $info = $select-&gt;query()-&gt;fetch();      if( empty($info) ) {       $db-&gt;insert('engine4_core_pages', array(         'name' =&gt; 'car_index_view',         'displayname' =&gt; 'Car View Page',         'title' =&gt; 'View Car',         'description' =&gt; 'This is the view page for a car.',         'custom' =&gt; 0,         'provides' =&gt; 'subject=car',       ));       $page_id = $db-&gt;lastInsertId('engine4_core_pages');        // containers       $db-&gt;insert('engine4_core_content', array(         'page_id' =&gt; $page_id,         'type' =&gt; 'container',         'name' =&gt; 'main',         'parent_content_id' =&gt; null,         'order' =&gt; 1,         'params' =&gt; '',       ));       $container_id = $db-&gt;lastInsertId('engine4_core_content');         $db-&gt;insert('engine4_core_content', array(         'page_id' =&gt; $page_id,         'type' =&gt; 'container',         'name' =&gt; 'left',         'parent_content_id' =&gt; $container_id,         'order' =&gt; 1,         'params' =&gt; '',       ));       $left_id = $db-&gt;lastInsertId('engine4_core_content');        $db-&gt;insert('engine4_core_content', array(         'page_id' =&gt; $page_id,         'type' =&gt; 'container',         'name' =&gt; 'right',         'parent_content_id' =&gt; $container_id,         'order' =&gt; 1,         'params' =&gt; '',       ));       $right_id = $db-&gt;lastInsertId('engine4_core_content');        $db-&gt;insert('engine4_core_content', array(         'page_id' =&gt; $page_id,         'type' =&gt; 'container',         'name' =&gt; 'middle',         'parent_content_id' =&gt; $container_id,         'order' =&gt; 3,         'params' =&gt; '',       ));       $middle_id = $db-&gt;lastInsertId('engine4_core_content');              // middle column content       $db-&gt;insert('engine4_core_content', array(         'page_id' =&gt; $page_id,         'type' =&gt; 'widget',         'name' =&gt; 'core.container-tabs',         'parent_content_id' =&gt; $middle_id,         'order' =&gt; 1,         'params' =&gt; '{"max":6}'       ));       $container_tabs_id = $db-&gt;lastInsertId('engine4_core_content');        $db-&gt;insert('engine4_core_content', array(         'page_id' =&gt; $page_id,         'type' =&gt; 'widget',         'name' =&gt; 'activity.feed',         'parent_content_id' =&gt; $container_tabs_id,         'order' =&gt; 1,         'params' =&gt; '{"title":"Activity"}',       ));        $db-&gt;insert('engine4_core_content', array(         'page_id' =&gt; $page_id,         'type' =&gt; 'widget',         'name' =&gt; 'car.profile-fields',         'parent_content_id' =&gt; $container_tabs_id,         'order' =&gt; 2,         'params' =&gt; '{"title":"Info"}',       ));        $db-&gt;insert('engine4_core_content', array(         'page_id' =&gt; $page_id,         'type' =&gt; 'widget',         'name' =&gt; 'car.profile-albums',         'parent_content_id' =&gt; $container_tabs_id,         'order' =&gt; 3,         'params' =&gt; '{"title":"Albums","titleCount":true}',       ));        $db-&gt;insert('engine4_core_content', array(         'page_id' =&gt; $page_id,         'type' =&gt; 'widget',         'name' =&gt; 'car.profile-videos',         'parent_content_id' =&gt; $container_tabs_id,         'order' =&gt; 4,         'params' =&gt; '{"title":"Videos","titleCount":true}',       ));        // right column       $db-&gt;insert('engine4_core_content', array(         'page_id' =&gt; $page_id,         'type' =&gt; 'widget',         'name' =&gt; 'car.show-same-tags',         'parent_content_id' =&gt; $right_id,         'order' =&gt; 1,         'params' =&gt; '',       ));        $db-&gt;insert('engine4_core_content', array(         'page_id' =&gt; $page_id,         'type' =&gt; 'widget',         'name' =&gt; 'car.show-also-liked',         'parent_content_id' =&gt; $right_id,         'order' =&gt; 2,         'params' =&gt; '',       ));        $db-&gt;insert('engine4_core_content', array(         'page_id' =&gt; $page_id,         'type' =&gt; 'widget',         'name' =&gt; 'car.show-same-poster',         'parent_content_id' =&gt; $right_id,         'order' =&gt; 3,         'params' =&gt; '',       ));        // left column       $db-&gt;insert('engine4_core_content', array(         'page_id' =&gt; $page_id,         'type' =&gt; 'widget',         'name' =&gt; 'car.profile-photo',         'parent_content_id' =&gt; $left_id,         'order' =&gt; 1,         'params' =&gt; '',       ));        $db-&gt;insert('engine4_core_content', array(         'page_id' =&gt; $page_id,         'type' =&gt; 'widget',         'name' =&gt; 'car.profile-ratings',         'parent_content_id' =&gt; $left_id,         'order' =&gt; 2,         'params' =&gt; '',       ));        $db-&gt;insert('engine4_core_content', array(         'page_id' =&gt; $page_id,         'type' =&gt; 'widget',         'name' =&gt; 'car.profile-options',         'parent_content_id' =&gt; $left_id,         'order' =&gt; 3,         'params' =&gt; '',       ));        $db-&gt;insert('engine4_core_content', array(         'page_id' =&gt; $page_id,         'type' =&gt; 'widget',         'name' =&gt; 'car.profile-info',         'parent_content_id' =&gt; $left_id,         'order' =&gt; 4,         'params' =&gt; '',       ));     }   } } ]]></script> This class' onInstall method runs when the module is install and construct the pages that we need to be editable in the layout editor. Page construction involves checking the page already exists and creating it if it doesn't. The first item that goes in the page is the main container. The main containers contain the sub-containers: top, right, bottom, left and middle. Finally sub-containers contain blocks/widgets.<br /><br />The location and position of widgets/containers are saved in engine4_core_content. A brief description of the fields on this table follows:<br /><ul><li><b>content_id</b> - the tables primary key. In a widget's controller this value can be retrieved by $this-&gt;getElement()-&gt;getIdentity(). This value is usually used on ajax paginated widgets like profile.cars</li><li><b>page_id</b> - the page_id of the page containing the widget/container</li><li><b>type</b> - widget or container</li><li>name - the full name of the widget (&lt;modulename&gt;.&lt;widget-name&gt;) if type is widget or 'main', 'top', 'right', 'bottom', 'left' and 'middle' if type is container.</li><li><b>params</b> - not applicable for containers. For widgets this is the widget parameters as set in the layout editor</li><li><b>parent_content_id </b>- the content_id of the widget/container that contains this widget/container</li><li><b>order</b> - the other in which the widget/container as appears on its parent widget/container</li><li><b>attribs</b> - unused</li></ul>This completes our discussion on widgets and pages. <br /><del>Stuff that the end user can see. The next part of the series we discuss background stuff -- Tasks and Jobs.</del>The next part discusses <a href="{{ site.baseurl }}{% post_url 2013-07-22-the-complete-guide-to-social-engine-4 %}" target="_blank">forms and form elements</a>.