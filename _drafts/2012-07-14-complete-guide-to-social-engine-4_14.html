---
layout: post
title: 'The Complete Guide to Social Engine 4 Module Development Part 2: Model, Item,
  Db Table'
date: '2012-07-14T19:01:00.002-07:00'
author: Marco Enrico
tags:
- item
- dbtable
- model
- api
modified_time: '2014-02-18T12:29:42.315-08:00'
blogger_id: tag:blogger.com,1999:blog-8533127149230967660.post-114320424821735035
blogger_orig_url: http://social-engine-tutorials.blogspot.com/2012/07/complete-guide-to-social-engine-4_14.html
---

The stuff that makes SocialEngine4 go are items. Items are the things that go around the community. Photos, albums, groups, videos even users are items in the context of SE4. Items normally have title, description, body or content, slug, owners, parents etc. Items can be shared, commented on and liked.<br /><br />In our module we have cars. Cars are owned by users. They have a profile page, a profile photo, can be liked, shared, commented on, can have a number of photos and can have videos.<br /><br />Please note the following regarding items in SE4:<br /><ul><li>Items have type which is the item's name prefixed with the enclosing module's name and an underscore. In our case it's <code>car_car</code>. The prefixed can be dropped but adjustments must be made <a href="#tables">elsewhere</a>.</li><li>Item name/type is used as database table names. It follows than you can only use characters that are allowed in mysql table names. I don't have an exhaustive list but to be safe use only alphanumeric characters and underscores.</li><li>Items have a globally unique identifier which formed by the item's type an underscore and the primary key of the item. For example <code>car_1</code>.</li><li>Items' class extends <code>Core_Model_Item_Abstract</code>.</li><li>Items class declaration resides in <code>application/modules/&lt;ModuleName&gt;/Model/&lt;ItemName&gt;.php</code></li><li>The class name is prefixed with <code>&lt;ModuleName&gt;_Model_</code></li><li>Item's can be retrieved anywhere using <code>Engine_Api::_()-&gt;getItem('&lt;item_type&gt;', '&lt;item_id&gt;')</code> or <code>Engine_Api::_()-&gt;getItemByGuid('&lt;item_guid&gt;')</code>. In view scripts items can be retrieved using the item view helper <code>$this-&gt;item('&lt;item_type&gt;', '&lt;item_id&gt;')</code>. To be able to use these methods the item must be declared in the module's manifest. This is done by adding an 'items' key in the manifest. In our case:<br /><br /><script class="brush:php" type="syntaxhighlighter"><![CDATA[ <?php  return array (   'package' =>  array (     'type' => 'module',     'name' => 'car',     'version' => '4.0.0',     'path' => 'application/modules/Car',     'title' => 'Car',     'description' => 'Car',     'author' => 'http://social-engine-tutorials.blogspot.com/',     'callback' => array (       'class' => 'Engine_Package_Installer_Module',     ),     'actions' =>    array (       0 => 'install',       1 => 'upgrade',       2 => 'refresh',       3 => 'enable',       4 => 'disable',     ),     'directories' => array (       0 => 'application/modules/Car',     ),     'files' => array (       0 => 'application/languages/en/car.csv',     ),   ),   'items' => array(     'car_car'   ), );  ]]></script><br /><br />In addition the module's core api must be defined. Create the directory application/modules/Car/Api and create the file Api/Core.php:<br /><br /><script class="brush:php" type="syntaxhighlighter"><![CDATA[ <?php   class Car_Api_Core extends Core_Api_Abstract { } ]]></script><br />Another way to retrieve an item is via the items table discussed <a href="https://www.blogger.com/blogger.g?blogID=8533127149230967660#below">below</a>. </li></ul><br />Create the file application/modules/Car/Model/Car.php:<br /><br /><script class="brush:php" type="syntaxhighlighter"><![CDATA[ <?php   class Car_Model_Car extends Core_Model_Item_Abstract { } ]]></script> <br />and the file application/modules/Car/Model/DbTable/Cars.php:<br /><br /><script class="brush:php" type="syntaxhighlighter"><![CDATA[ <?php   // Cars/Model/DbTable/Cars.php   class Car_Model_DbTable_Cars extends Engine_Db_Table {   protected $_rowClass = 'Car_Model_Car'; }  ]]></script> <br />And in application/modules/Car/settings/my.sql: <br /><script class="brush:sql" type="syntaxhighlighter"><![CDATA[ -- Cars/settings/my.sql   DROP TABLE IF EXISTS engine4_car_cars; CREATE TABLE engine4_car_cars (     car_id INT(11) UNSIGNED NOT NULL AUTO_INCREMENT,     title VARCHAR(128) NOT NULL,     description MEDIUMTEXT NOT NULL,     owner_id INT(11) UNSIGNED NOT NULL,     owner_type INT(11) UNSIGNED NOT NULL,     photo_id INT(11) UNSIGNED NOT NULL,     creation_date DATETIME NOT NULL,     modified_date DATETIME NOT NULL,     view_count INT(11) UNSIGNED NOT NULL,     comment_count INT(11) UNSIGNED NOT NULL,     search TINYINT(1) NOT NULL,     PRIMARY KEY (car_id),     INDEX (photo_id),     INDEX (owner_id) );  ]]></script> <br />Run the query in mysql as well.<br /><br />Please note the following:<br /><br /><ul><li><span style="background-color: white;">The table class name is the item name prefixed with &lt;Modulename&gt;_Model_DbTable_ and suffixed with an "s". SE4 tries to pluralize the name of your item. Take for example the item "members" in the module "family". The item name is "members" and type is "family_members". The table class name is Family_Model_DbTable_Members. SE4 attempts to pluralize the item name such that category becomes categories and key becomes keys. If the item name is already plural SE4 doesn't attempt to pluralize.</span></li><li><span style="background-color: white;">The corresponding mysql table name is the item type prefixed with engine4_ and suffixed with an "s". The "s" suffix is added only as needed following the pluralization that SE4 follows discussed above.</span></li><li id="tables"><span style="background-color: white;">As mentioned above the item type prefix can be dropped. In our case if we choose not to use the default item type "car_car" an use "car" instead, then the item type we declare in the manifest is "car". In the item's table we set $_name to "cars" and our the mysql table name will be engine4_cars.</span></li><li id="tables"><span style="background-color: white;">To get an instance of the db table we use Engine_Api::_()-&gt;getDbTable('&lt;item_name_s_suffixed&gt;', '&lt;module_name&gt;').&nbsp; <span id="below">Another way is via Engine_Api::_()-&gt;getItemTable('&lt;item_type&gt;'). This only works if the item is declared in the manifest and the modules core api is declared. To</span> get an item via it's id we use Engine_Api::_()-&gt;getDbTable(...)-&gt;find(&lt;id&gt;)-&gt;current.</span></li><li id="tables"><span style="background-color: white;">Engine_Db_Table extends Zend_Db_Table you may refer to the <a href="http://framework.zend.com/manual/en/zend.db.table.html">zf documentation</a> to see what you have at your disposal. </span></li></ul>Lets go back to the my.sql file. Queries in this file are run when the module is installed. Since this file doesn't exist when we install our module at the start development we had to run this manually. Any errors encountered the execution of the statements in this file will cause the whole installation process to fail.<br /><br />Since as mentioned earlier, cars have owners, we have owner_id, owner_type in the table definition.&nbsp; With this we can query for the owner of a car using the getOwner method. By default the owner type is user so getOwner will return an instance of User_Model_User. In the future we may decide that other items can own cars. So for example we may decide that groups can own cars. A car owned by a group will have an owner_type of 'group_group' and calling getOwner in that instance of car will return an instance of Group_Model_Group.<br /><br />Items can also have parents. The table definition must have a parent_type and parent_id which work just like owner_type and owner_id. getParent() and getChildren will be at your disposal if you plan on using parents/children on items. In addition you may set the property protected property $_parent_is_owner to make the getParent() return the owner of the item. <br /><br />Cars have a primary photo. That is why on the table definition we have photo_id. When to photo_id is set. We can use the getPhotoUrl on the item to get the url of the photo file. It accepts an optional parameter that controls the size of the image whose url will be returned. In view scripts the itemPhoto view helper can be used to generate an image tag for an item's photo.<br /><br />Items can be liked, commented on and tagged. To enable any or all to this you just need to add the interface in the item's model class:<br /><br /><script class="brush:php" type="syntaxhighlighter"><![CDATA[   public function comments()   {     return new Engine_ProxyObject($this, Engine_Api::_()->getDbtable('comments', 'core'));   }    public function likes()   {     return new Engine_ProxyObject($this, Engine_Api::_()->getDbtable('likes', 'core'));   }    public function tags()   {     return new Engine_ProxyObject($this, Engine_Api::_()->getDbtable('tags', 'core'));   }  ]]></script> <br />That covers everything about items, models, and db tables. You may now proceed to the <a href="{{ site.baseurl }}{% post_url 2012-07-24-the-complete-guide-to-social-engine-4 %}">next step</a>.<br /><ul></ul>